class DBHelper{static get PORT(){return 1337}static get RESTAURANT_API(){return`http://localhost:${DBHelper.PORT}/restaurants`}static get RESTAURANT_REVIEWS_API(){return`http://localhost:${DBHelper.PORT}/reviews/?restaurant_id=${DBHelper.getParameterByName("id")}`}static get REVIEWS_API(){return`http://localhost:${DBHelper.PORT}/reviews/`}static get RESTAURANT_IDB_NAME(){return"RestaurantDB"}static get RESTAURANT_IDB_STORE_NAME(){return"RestaurantStore"}static get REVIEWS_IDB_NAME(){return"ReviewsDB"}static get REVIEWS_IDB_STORE_NAME(){return"ReviewsStore"}static get REVIEWS_OFFLINE_IDB_NAME(){return"OfflineReviewsCacheDB"}static get REVIEWS_OFFLINE_STORE_NAME(){return"OfflineReviewsCacheStoore"}static getParameterByName(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");const r=new RegExp(`[?&]${e}(=([^&#]*)|&|#|$)`).exec(t);return r?r[2]?decodeURIComponent(r[2].replace(/\+/g," ")):"":null}static fetchRestaurants(){return navigator.onLine?fetch(DBHelper.RESTAURANT_API).then(e=>e.json()).then(e=>(DBHelper.createIDBStore(e,DBHelper.RESTAURANT_IDB_NAME,DBHelper.RESTAURANT_IDB_STORE_NAME),e)).catch(e=>console.error(`ERR_FETCHING_RESTAURANTS: ${e}`)):new Promise((e,t)=>{DBHelper.getCachedData(DBHelper.RESTAURANT_IDB_NAME,DBHelper.RESTAURANT_IDB_STORE_NAME).then(t=>e(t)).catch(e=>console.warn(`ERR_FETCHING_CACHED_RESTAURANTS: ${e.message}`))})}static fetchRestaurantById(e){return DBHelper.fetchRestaurants().then(t=>t.find(t=>t.id==e)).then(e=>e).catch(e=>console.error(`ERR_FETCHING_RESTAURANT_BY_ID: ${e}`))}static fetchRestaurantByCuisine(e){return DBHelper.fetchRestaurants().then(t=>t.filter(t=>t.cuisine_type==e)).then(e=>e).catch(e=>console.error(`ERR_FETCHING_RESTAURANT_BY_CUISINE: ${e}`))}static fetchRestaurantByNeighborhood(e){return DBHelper.fetchRestaurants().then(t=>t.filter(t=>t.neighborhood==e)).then(e=>e).catch(e=>console.error(`ERR_FETCHING_RESTAURANT_BY_NEIGHBOURHOOD: ${e}`))}static fetchRestaurantByCuisineAndNeighborhood(e,t){return DBHelper.fetchRestaurants().then(r=>{let n=r;return"all"!=t&&(n=r.filter(e=>e.cuisine_type==t)),"all"!=e&&(n=r.filter(t=>t.neighborhood==e)),n}).catch(e=>console.error(`ERR_FETCHING_RESTAURANT_BY_CUISINE_NEIGHBOURHOOD: ${e}`))}static fetchReviews(){return navigator.onLine?fetch(DBHelper.REVIEWS_API).then(e=>e.json()).then(e=>(DBHelper.createIDBStore(e,DBHelper.REVIEWS_IDB_NAME,DBHelper.REVIEWS_IDB_STORE_NAME),e)).catch(e=>console.error(`ERR_FETCHING_ALL_REVIEWS: ${e}`)):new Promise((e,t)=>{DBHelper.getCachedData(DBHelper.REVIEWS_IDB_NAME,DBHelper.REVIEWS_IDB_STORE_NAME).then(t=>e(t)).catch(e=>console.error(`ERR_FETCHING_REVIEWS_FROM_IDB: ${e}`))})}static fetchReviewsByRestaurantId(e){return DBHelper.fetchReviews().then(t=>t.filter(t=>t.restaurant_id==e)).then(e=>navigator.onLine?fetch(DBHelper.RESTAURANT_REVIEWS_API).then(e=>e.json()).catch(e=>console.err(`ERR_FETCHING_REVIEW: ${e}`)):e).catch(e=>console.error(`ERR_FETCH_REVIEWS_BY_RESTAURANT_ID: ${e}`))}static fetchNeighborhoods(){return DBHelper.fetchRestaurants().then(e=>{const t=e.map((t,r)=>e[r].neighborhood);return t.filter((e,r)=>t.indexOf(e)==r)}).catch(e=>console.error(`ERR_FETCHING_NEIGHBORHOODS: ${e}`))}static fetchCuisines(){return DBHelper.fetchRestaurants().then(e=>{const t=e.map((t,r)=>e[r].cuisine_type);return t.filter((e,r)=>t.indexOf(e)==r)}).catch(e=>console.error(`ERR_FETCHING_CUISINES: ${e}`))}static createIDBStore(e,t,r){let n=(window.indexedDB||window.mozIndexedDB||window.webkiteIndexedDB||window.msIndexedDB||window.shimIndexedDB).open(t,1);n.onupgradeneeded=function(){n.result.createObjectStore(r,{keyPath:"id"}).createIndex("by-id","id")},n.onerror=function(e){console.error(`IndexedDB error: ${e.target.errorCode}`)},n.onsuccess=function(){let t=n.result,o=t.transaction(r,"readwrite"),a=o.objectStore(r);a.index("by-id");e.forEach(e=>a.put(e)),o.oncomplete=function(){t.close()}}}static cacheObject(e,t,r){let n=(window.indexedDB||window.mozIndexedDB||window.webkiteIndexedDB||window.msIndexedDB||window.shimIndexedDB).open(t,1);n.onupgradeneeded=function(){let e=n.result,o={keyPath:"id"};if(t==DBHelper.REVIEWS_OFFLINE_IDB_NAME){o={keyPath:void 0,unique:!1,autoIncrement:!1};e.createObjectStore(r,o)}else{e.createObjectStore(r,o).createIndex("by-id","id")}},n.onerror=function(e){console.error(`IndexedDB error: ${e.target.errorCode}`)},n.onsuccess=function(){let o=n.result,a=o.transaction(r,"readwrite"),i=a.objectStore(r);if(t==DBHelper.REVIEWS_OFFLINE_IDB_NAME)i.put(e,1);else{i.index("by-id");i.put(e)}a.oncomplete=function(){o.close()}}}static getCachedData(e,t){return new Promise((r,n)=>{let o=(window.indexedDB||window.mozIndexedDB||window.webkiteIndexedDB||window.msIndexedDB||window.shimIndexedDB).open(e,1);o.onsuccess=(()=>{let e=o.result,n=e.transaction(t,"readwrite"),a=n.objectStore(t).getAll();a.onsuccess=(()=>{r(a.result)}),n.oncomplete=(()=>{e.close()})})})}static clearStore(e,t){let r=(window.indexedDB||window.mozIndexedDB||window.webkiteIndexedDB||window.msIndexedDB||window.shimIndexedDB).open(e,1);r.onsuccess=(()=>{r.result.transaction(t,"readwrite").objectStore(t).clear()}),tx.oncomplete=(()=>{db.close()})}static mapMarkerForRestaurant(e,t){return new google.maps.Marker({position:e.latlng,title:e.name,url:DBHelper.urlForRestaurant(e),map:t,animation:google.maps.Animation.DROP})}static urlForRestaurant(e){return`./restaurant.html?id=${e.id}`}static imageUrlForRestaurant(e){return void 0===e.photograph?"/dist/img/no_image.webp":`/dist/img/${e.photograph}.webp`}static lazyLoad(){"undefined"!=typeof LazyLoad&&new LazyLoad({elements_selector:".restaurant-img"})}static getRestaurantByIdApiUrl(e){return`http://localhost:${DBHelper.PORT}/restaurants/${e}`}static favoriteRestaurant(e,t){t||(t=!1),fetch(DBHelper.getRestaurantByIdApiUrl(e),{method:"put",body:JSON.stringify({is_favorite:!t})}).then(e=>e.json()).then(e=>{let t=document.getElementById(`${e.id}`);t.href=`javascript:DBHelper.favoriteRestaurant(${e.id}, ${e.is_favorite})`,t.innerHTML=e.is_favorite?"Remove Favorite":"Set Favorite",DBHelper.cacheObject(e,DBHelper.RESTAURANT_IDB_NAME,DBHelper.RESTAURANT_IDB_STORE_NAME)}).catch(e=>console.error(`ERROR_UPDATING_FAVOURITE_RESTAURANT: ${e}`))}static postReview(e){return fetch(DBHelper.REVIEWS_API,{method:"post",body:JSON.stringify(e)}).then(e=>e.json()).then(e=>(DBHelper.cacheObject(e,DBHelper.REVIEWS_IDB_NAME,DBHelper.REVIEWS_IDB_STORE_NAME),e)).catch(e=>console.error(`ERROR_POSTING_REVIEW: ${e}`))}static postCachedReviews(){if(navigator.onLine)return new Promise((e,t)=>{DBHelper.getCachedData(DBHelper.REVIEWS_OFFLINE_IDB_NAME,DBHelper.REVIEWS_OFFLINE_STORE_NAME).then(e=>{e.forEach(e=>{DBHelper.postReview(e).then(e=>{document.getElementById("form-legend").innerHTML="Your review has been added.",document.getElementById("reviews-form").reset(),console.log(`SAVED_REVIEW: ${e}`)})})}).then(()=>DBHelper.clearStore(DBHelper.REVIEWS_OFFLINE_IDB_NAME,DBHelper.REVIEWS_OFFLINE_STORE_NAME)).catch(e=>console.error(`ERROR_SAVING_CACHED_REVIEWS: ${e}`))})}}